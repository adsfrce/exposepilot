<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ExposePilot Dashboard</title>
</head>
<body>

  <!-- Session Check -->
  <script>
  fetch("https://expose-api.black-bar-1b40.workers.dev/me", {
    credentials: "include"
  })
    .then(res => res.json())
    .then(data => {
      if (!data.logged_in) {
        window.location.href = "login.html";
        return;
      }
      document.getElementById("welcome").textContent =
        "Willkommen, " + data.user.company_name;
    });
  </script>

  <h1 id="welcome">Dashboard wird geladen...</h1>
  <p>Dies ist das ExposePilot Backend. (Design machen wir später schön.)</p>

  <!-- BRANDING -->
  <h2>Branding</h2>
  <form id="brandingForm">
    <label>Firmenname:</label><br>
    <input type="text" id="company_name"><br><br>

    <label>Primärfarbe (HEX):</label><br>
    <input type="text" id="primary_color" placeholder="#000000"><br><br>

    <label>Sekundärfarbe (HEX):</label><br>
    <input type="text" id="secondary_color" placeholder="#ffffff"><br><br>

    <button type="submit">Speichern</button>
  </form>

  <p id="brandingStatus" style="color:green;"></p>

  <hr>

  <!-- EXPOSÉ ERSTELLEN -->
  <h2>Neues Exposé</h2>
  <form id="exposeForm">
    <label>Titel:</label><br>
    <input type="text" id="expose_title"><br><br>

    <label>Wohnfläche (qm):</label><br>
    <input type="number" id="wohnflaeche"><br><br>

    <label>Grundstück (qm):</label><br>
    <input type="number" id="grundstueck"><br><br>

    <label>Baujahr:</label><br>
    <input type="text" id="baujahr"><br><br>

    <label>Zimmer:</label><br>
    <input type="number" id="zimmer"><br><br>

    <label>Template (1–4):</label><br>
    <input type="number" id="template_id" value="1"><br><br>

    <button type="submit">Exposé anlegen</button>
  </form>

  <p id="exposeStatus" style="color:green;"></p>

  <hr>

  <h2>Meine Exposés (klicken, um Bilder & Text zu bearbeiten)</h2>
  <ul id="exposeList"></ul>

  <hr>

  <!-- BILDERUPLOAD -->
  <h2>Bilder für Exposé</h2>
  <p>Aktives Exposé: <span id="activeExposeId">keins</span></p>

  <div id="dropZone" style="border:1px dashed #666; padding:20px; max-width:400px; margin-bottom:10px;">
    Bilder hier per Drag & Drop ablegen oder Button nutzen.
  </div>

  <button id="selectImagesBtn">Bilder auswählen</button>
  <input type="file" id="imageFiles" multiple style="display:none">
  <button id="uploadImagesBtn">Bilder hochladen</button>

  <p id="uploadStatus" style="color:green;"></p>

  <h3>Hochgeladene Bilder</h3>
  <ul id="imageList"></ul>

  <hr>

  <!-- GPT TEXTE -->
  <h2>Exposé-Text (GPT)</h2>
  <button id="generateTextBtn">Texte generieren für aktives Exposé</button>
  <p id="gptStatus" style="color:blue;"></p>
  <br>
  <textarea id="gptText" style="width:100%; max-width:800px; height:300px;"></textarea>

  <p><a href="logout.html">Logout</a></p>

  <!-- SCRIPT -->
  <script>
  // Branding
  async function loadBranding() {
    const res = await fetch("https://expose-api.black-bar-1b40.workers.dev/branding/get", {
      credentials: "include"
    });
    const data = await res.json();
    if (!data.logged_in) return;

    document.getElementById("company_name").value = data.user.company_name || "";
    document.getElementById("primary_color").value = data.user.primary_color || "";
    document.getElementById("secondary_color").value = data.user.secondary_color || "";
  }

  document.getElementById("brandingForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const company_name = document.getElementById("company_name").value;
    const primary_color = document.getElementById("primary_color").value;
    const secondary_color = document.getElementById("secondary_color").value;

    const res = await fetch("https://expose-api.black-bar-1b40.workers.dev/branding/save", {
      method: "POST",
      credentials: "include",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ company_name, primary_color, secondary_color })
    });

    const data = await res.json();
    if (data.ok) {
      document.getElementById("brandingStatus").textContent = "Gespeichert.";
    }
  });

  loadBranding();

  // ===== Exposé + Bilder + GPT =====
  let activeExposeId = null;
  let uploadFiles = [];

  // Exposé erstellen
  document.getElementById("exposeForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const data = {
      title: document.getElementById("expose_title").value,
      template_id: Number(document.getElementById("template_id").value),
      data_json: {
        wohnflaeche: Number(document.getElementById("wohnflaeche").value),
        grundstueck: Number(document.getElementById("grundstueck").value),
        baujahr: document.getElementById("baujahr").value,
        zimmer: Number(document.getElementById("zimmer").value)
      }
    };

    const res = await fetch("https://expose-api.black-bar-1b40.workers.dev/expose/create", {
      method: "POST",
      credentials: "include",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });

    const jsonData = await res.json();
    if (jsonData.ok) {
      document.getElementById("exposeStatus").textContent = "Exposé gespeichert.";
      loadExposeList();
    }
  });

  async function loadExposeList() {
    const res = await fetch("https://expose-api.black-bar-1b40.workers.dev/expose/list", {
      credentials: "include"
    });
    const data = await res.json();

    const list = document.getElementById("exposeList");
    list.innerHTML = "";

    (data.exposes || []).forEach(exp => {
      const li = document.createElement("li");
      li.textContent = exp.title + " (ID: " + exp.id + ")";
      li.style.cursor = "pointer";
      li.addEventListener("click", () => {
        setActiveExpose(exp.id);
      });
      list.appendChild(li);
    });
  }

  function setActiveExpose(id) {
    activeExposeId = id;
    document.getElementById("activeExposeId").textContent = id;
    loadImages();
    document.getElementById("gptText").value = "";
    document.getElementById("gptStatus").textContent = "";
  }

  // Drag & Drop / File select
  const dropZone = document.getElementById("dropZone");
  const imageInput = document.getElementById("imageFiles");
  const selectBtn = document.getElementById("selectImagesBtn");
  const uploadBtn = document.getElementById("uploadImagesBtn");
  const uploadStatus = document.getElementById("uploadStatus");

  function renderSelectedFiles() {
    if (!uploadFiles.length) {
      uploadStatus.textContent = "";
      return;
    }
    uploadStatus.textContent = uploadFiles.length + " Datei(en) ausgewählt.";
  }

  dropZone.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropZone.style.backgroundColor = "#f3f4f6";
  });

  dropZone.addEventListener("dragleave", (e) => {
    e.preventDefault();
    dropZone.style.backgroundColor = "transparent";
  });

  dropZone.addEventListener("drop", (e) => {
    e.preventDefault();
    dropZone.style.backgroundColor = "transparent";
    uploadFiles = Array.from(e.dataTransfer.files);
    renderSelectedFiles();
  });

  selectBtn.addEventListener("click", () => {
    imageInput.click();
  });

  imageInput.addEventListener("change", (e) => {
    uploadFiles = Array.from(e.target.files);
    renderSelectedFiles();
  });

  uploadBtn.addEventListener("click", async () => {
    if (!activeExposeId) {
      alert("Bitte zuerst ein Exposé in der Liste auswählen.");
      return;
    }
    if (!uploadFiles.length) {
      alert("Keine Dateien ausgewählt.");
      return;
    }

    const formData = new FormData();
    formData.append("expose_id", activeExposeId);
    uploadFiles.forEach(file => formData.append("files", file));

    uploadStatus.textContent = "Upload läuft...";

    const res = await fetch("https://expose-api.black-bar-1b40.workers.dev/expose/upload", {
      method: "POST",
      credentials: "include",
      body: formData
    });

    const data = await res.json();
    if (data.ok) {
      uploadStatus.textContent = "Upload abgeschlossen (" + data.saved + " Dateien).";
      uploadFiles = [];
      imageInput.value = "";
      loadImages();
    } else {
      uploadStatus.textContent = data.error || "Fehler beim Upload.";
    }
  });

  async function loadImages() {
    if (!activeExposeId) return;
    const res = await fetch("https://expose-api.black-bar-1b40.workers.dev/expose/images?expose_id=" + activeExposeId, {
      credentials: "include"
    });
    const data = await res.json();

    const list = document.getElementById("imageList");
    list.innerHTML = "";

    (data.images || []).forEach(img => {
      const li = document.createElement("li");
      li.textContent = img.filename + " (ID: " + img.id + ")";
      list.appendChild(li);
    });
  }

  // GPT Text generieren
  document.getElementById("generateTextBtn").addEventListener("click", async () => {
    if (!activeExposeId) {
      alert("Bitte zuerst ein Exposé in der Liste auswählen.");
      return;
    }

    document.getElementById("gptStatus").textContent = "Texte werden generiert...";
    document.getElementById("gptText").value = "";

    const res = await fetch("https://expose-api.black-bar-1b40.workers.dev/expose/generate-text", {
      method: "POST",
      credentials: "include",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ expose_id: activeExposeId })
    });

    const data = await res.json();

    if (!data.ok) {
      document.getElementById("gptStatus").textContent = data.error || "Fehler bei der Textgenerierung.";
      return;
    }

    document.getElementById("gptStatus").textContent = "Texte generiert.";
    document.getElementById("gptText").value = data.text;
  });

  // initial
  loadExposeList();
  </script>

</body>
</html>
