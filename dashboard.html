<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ExposePilot Dashboard</title>
</head>
<body>

  <!-- Session Check -->
  <script>
  fetch("https://expose-api.black-bar-1b40.workers.dev/me", {
    credentials: "include"
  })
    .then(res => res.json())
    .then(data => {
      if (!data.logged_in) {
        window.location.href = "login.html";
        return;
      }
      document.getElementById("welcome").textContent =
        "Willkommen, " + data.user.company_name;
    });
  </script>

  <h1 id="welcome">Dashboard wird geladen...</h1>
  <p>Dies ist das ExposePilot Backend. (Wir designen das später schön.)</p>

  <!-- BRANDING -->
  <h2>Branding</h2>
  <form id="brandingForm">
    <label>Firmenname:</label><br>
    <input type="text" id="company_name"><br><br>

    <label>Primärfarbe (HEX):</label><br>
    <input type="text" id="primary_color" placeholder="#000000"><br><br>

    <label>Sekundärfarbe (HEX):</label><br>
    <input type="text" id="secondary_color" placeholder="#ffffff"><br><br>

    <button type="submit">Speichern</button>
  </form>

  <p id="brandingStatus" style="color:green;"></p>

  <hr>

  <!-- EXPOSÉ ERSTELLEN -->
  <h2>Neues Exposé</h2>

  <form id="exposeForm">
    <label>Titel:</label><br>
    <input type="text" id="expose_title"><br><br>

    <label>Wohnfläche (qm):</label><br>
    <input type="number" id="wohnflaeche"><br><br>

    <label>Grundstück (qm):</label><br>
    <input type="number" id="grundstueck"><br><br>

    <label>Baujahr:</label><br>
    <input type="text" id="baujahr"><br><br>

    <label>Zimmer:</label><br>
    <input type="number" id="zimmer"><br><br>

    <label>Template (1–4):</label><br>
    <input type="number" id="template_id" value="1"><br><br>

    <button type="submit">Exposé anlegen</button>
  </form>

  <p id="exposeStatus" style="color:green;"></p>

  <hr>

  <h2>Meine Exposés</h2>
  <ul id="exposeList"></ul>

  <p><a href="logout.html">Logout</a></p>

  <!-- BRANDING & EXPOSE SCRIPTS -->
  <script>
  async function loadBranding() {
    const res = await fetch("https://expose-api.black-bar-1b40.workers.dev/branding/get", {
      credentials: "include"
    });
    const data = await res.json();

    if (!data.logged_in) return;

    document.getElementById("company_name").value = data.user.company_name || "";
    document.getElementById("primary_color").value = data.user.primary_color || "";
    document.getElementById("secondary_color").value = data.user.secondary_color || "";
  }

  document.getElementById("brandingForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const company_name = document.getElementById("company_name").value;
    const primary_color = document.getElementById("primary_color").value;
    const secondary_color = document.getElementById("secondary_color").value;

    const res = await fetch("https://expose-api.black-bar-1b40.workers.dev/branding/save", {
      method: "POST",
      credentials: "include",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ company_name, primary_color, secondary_color })
    });

    const data = await res.json();
    if (data.ok) {
      document.getElementById("brandingStatus").textContent = "Gespeichert.";
    }
  });

  loadBranding();


  // EXPOSE CREATE
  document.getElementById("exposeForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const data = {
      title: document.getElementById("expose_title").value,
      template_id: Number(document.getElementById("template_id").value),
      data_json: {
        wohnflaeche: Number(document.getElementById("wohnflaeche").value),
        grundstueck: Number(document.getElementById("grundstueck").value),
        baujahr: document.getElementById("baujahr").value,
        zimmer: Number(document.getElementById("zimmer").value)
      }
    };

    const res = await fetch("https://expose-api.black-bar-1b40.workers.dev/expose/create", {
      method: "POST",
      credentials: "include",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });

    const jsonData = await res.json();
    if (jsonData.ok) {
      document.getElementById("exposeStatus").textContent = "Exposé gespeichert.";
      loadExposeList();
    }
  });

  // LIST LOAD
  async function loadExposeList() {
    const res = await fetch("https://expose-api.black-bar-1b40.workers.dev/expose/list", {
      credentials: "include"
    });
    const data = await res.json();

    const list = document.getElementById("exposeList");
    list.innerHTML = "";

    data.exposes.forEach(exp => {
      const li = document.createElement("li");
      li.textContent = exp.title + " (ID: " + exp.id + ")";
      list.appendChild(li);
    });
  }

  loadExposeList();
  </script>

</body>
</html>
